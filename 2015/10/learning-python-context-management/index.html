<!-- build time:Wed Jun 19 2019 16:37:33 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta name="referrer" content="no-referrer-when-downgrade"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#2a3f5b"><meta http-equiv="window-target" content="_top"><title>Python学习之上下文管理 | Stdio&#39;s Blog</title><meta name="description" content="最近突发奇想，想写一个能改变当前输出环境，输出彩色文字的上下文管理器，于是学习了一下上下文管理。"><meta name="keywords" content="python,上下文管理"><meta property="og:type" content="article"><meta property="og:title" content="Python学习之上下文管理"><meta property="og:url" content="https://blog.stdioa.com/2015/10/learning-python-context-management/index.html"><meta property="og:site_name" content="Stdio&#39;s Blog"><meta property="og:description" content="最近突发奇想，想写一个能改变当前输出环境，输出彩色文字的上下文管理器，于是学习了一下上下文管理。"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2018-07-12T00:14:50.518Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Python学习之上下文管理"><meta name="twitter:description" content="最近突发奇想，想写一个能改变当前输出环境，输出彩色文字的上下文管理器，于是学习了一下上下文管理。"><link rel="canonical" href="https://blog.stdioa.com/2015/10/learning-python-context-management/index.html"><link rel="alternate" href="/atom.xml" title="Stdio&#39;s Blog" type="application/atom+xml"><link rel="icon" href="/favicon.ico" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"></head><body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="/" target="_blank"><img class="img-circle img-rotate" src="https://www.gravatar.com/avatar/e452ed622e6b1e9a2067a06fde30cf30?s=128" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">David Dai</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md">Backend Developer</h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Nanjing, China</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="搜索"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav menu-highlight"><li class="menu-item menu-item-home"><a href="/"><i class="icon icon-home-fill"></i> <span class="menu-title">首页</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">归档</span></a></li><li class="menu-item menu-item-categories"><a href="/categories"><i class="icon icon-folder"></i> <span class="menu-title">分类</span></a></li><li class="menu-item menu-item-tags"><a href="/tags"><i class="icon icon-tags"></i> <span class="menu-title">标签</span></a></li><li class="menu-item menu-item-repository"><a href="/repository"><i class="icon icon-project"></i> <span class="menu-title">项目</span></a></li><li class="menu-item menu-item-sheets"><a href="http://sheet.stdioa.com/"><i class="icon icon-book"></i> <span class="menu-title">谱站</span></a></li><li class="menu-item menu-item-links"><a href="/links"><i class="icon icon-friendship"></i> <span class="menu-title">友链</span></a></li><li class="menu-item menu-item-about"><a href="/about"><i class="icon icon-cup-fill"></i> <span class="menu-title">关于</span></a></li></ul><ul class="social-links"><li><a href="https://github.com/StdioA" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="https://twitter.com/stdio_a" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top"><i class="icon icon-twitter"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li><li><a href="https://t.me/StdioA" target="_blank" title="Telegram" data-toggle="tooltip" data-placement="top"><i class="icon icon-telegram"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">公告</h3><div class="widget-body"><div id="board"><div class="content"><p>欢迎，你是第 <span id="busuanzi_value_site_pv">并不知道多少</span> 个来到这里的人。</p><p>不过我更新的比较少…不好意思。</p><p>另：本站使用 Disqus 评论系统，若文章页面下方无法显示评论框，那肯定是打开方式不对。</p></div></div></div></div><div class="widget"><h3 class="widget-title">分类</h3><div class="widget-body"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/DevOps/">DevOps</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Golang/">Golang</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Javascript/">Javascript</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/LeetCode/">LeetCode</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web/">Web</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/乱七八糟/">乱七八糟</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/开发/">开发</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/翻译/">翻译</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随手记/">随手记</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔/">随笔</a><span class="category-list-count">2</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签云</h3><div class="widget-body tagcloud"><a href="/tags/Ajax/" style="font-size:13px">Ajax</a> <a href="/tags/Apache/" style="font-size:13px">Apache</a> <a href="/tags/Atom/" style="font-size:13px">Atom</a> <a href="/tags/CI-CD/" style="font-size:13.5px">CI/CD</a> <a href="/tags/CTF/" style="font-size:13.17px">CTF</a> <a href="/tags/DevOps/" style="font-size:13.67px">DevOps</a> <a href="/tags/Django/" style="font-size:13.33px">Django</a> <a href="/tags/Django-REST-Framework/" style="font-size:13px">Django REST Framework</a> <a href="/tags/Docker/" style="font-size:13px">Docker</a> <a href="/tags/Git/" style="font-size:13.17px">Git</a> <a href="/tags/GitLab/" style="font-size:13.5px">GitLab</a> <a href="/tags/Github/" style="font-size:13.17px">Github</a> <a href="/tags/Golang/" style="font-size:13px">Golang</a> <a href="/tags/IPv6/" style="font-size:13px">IPv6</a> <a href="/tags/Javascript/" style="font-size:13.17px">Javascript</a> <a href="/tags/KMS/" style="font-size:13px">KMS</a> <a href="/tags/LCTT/" style="font-size:13px">LCTT</a> <a href="/tags/LeetCode/" style="font-size:13px">LeetCode</a> <a href="/tags/Let-s-Encrypt/" style="font-size:13px">Let's Encrypt</a> <a href="/tags/Linux/" style="font-size:13.33px">Linux</a> <a href="/tags/MySQL/" style="font-size:13.17px">MySQL</a> <a href="/tags/NAS/" style="font-size:13px">NAS</a> <a href="/tags/NTP/" style="font-size:13px">NTP</a> <a href="/tags/PHP/" style="font-size:13px">PHP</a> <a href="/tags/Prometheus/" style="font-size:13px">Prometheus</a> <a href="/tags/Python/" style="font-size:13.83px">Python</a> <a href="/tags/SQL/" style="font-size:13px">SQL</a> <a href="/tags/Sublime-Text/" style="font-size:13px">Sublime Text</a> <a href="/tags/Windows/" style="font-size:13px">Windows</a> <a href="/tags/collections/" style="font-size:13px">collections</a> <a href="/tags/ctypes/" style="font-size:13px">ctypes</a> <a href="/tags/git/" style="font-size:13px">git</a> <a href="/tags/gunicorn/" style="font-size:13px">gunicorn</a> <a href="/tags/logging/" style="font-size:13px">logging</a> <a href="/tags/nginx/" style="font-size:13.33px">nginx</a> <a href="/tags/node-js/" style="font-size:13.17px">node.js</a> <a href="/tags/openssl/" style="font-size:13px">openssl</a> <a href="/tags/pip/" style="font-size:13px">pip</a> <a href="/tags/python/" style="font-size:14px">python</a> <a href="/tags/requests/" style="font-size:13px">requests</a> <a href="/tags/supervisor/" style="font-size:13px">supervisor</a> <a href="/tags/unittest/" style="font-size:13px">unittest</a> <a href="/tags/virtualenv/" style="font-size:13px">virtualenv</a> <a href="/tags/vue-js/" style="font-size:13px">vue.js</a> <a href="/tags/wget/" style="font-size:13px">wget</a> <a href="/tags/七牛/" style="font-size:13px">七牛</a> <a href="/tags/上下文管理/" style="font-size:13px">上下文管理</a> <a href="/tags/前端开发/" style="font-size:13.33px">前端开发</a> <a href="/tags/后端开发/" style="font-size:13px">后端开发</a> <a href="/tags/堆/" style="font-size:13px">堆</a> <a href="/tags/微服务/" style="font-size:13.17px">微服务</a> <a href="/tags/数据库/" style="font-size:13px">数据库</a> <a href="/tags/数据迁移/" style="font-size:13px">数据迁移</a> <a href="/tags/文本编辑器/" style="font-size:13px">文本编辑器</a> <a href="/tags/算法/" style="font-size:13px">算法</a> <a href="/tags/编程工具/" style="font-size:13px">编程工具</a> <a href="/tags/脑洞/" style="font-size:13.17px">脑洞</a> <a href="/tags/读书/" style="font-size:13.5px">读书</a> <a href="/tags/迭代器/" style="font-size:13px">迭代器</a></div></div><div class="widget"><h3 class="widget-title">归档</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">三月 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">二月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">一月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">十二月 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">十一月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a><span class="archive-list-count">1</span></li></ul></div></div></div></aside><aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><nav id="toc" class="article-toc"><h3 class="toc-title">文章目录</h3><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-简介"><span class="toc-text">1. 简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-编写上下文管理器"><span class="toc-text">2. 编写上下文管理器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#21-__enter__函数"><span class="toc-text">2.1 __enter__函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22-__exit__函数"><span class="toc-text">2.2 __exit__函数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-综合示例"><span class="toc-text">3. 综合示例</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-参考文档"><span class="toc-text">4. 参考文档</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-后记"><span class="toc-text">5. 后记</span></a></li></ol></nav></div></aside><main class="main" role="main"><div class="content"><article id="post-learning-python-context-management" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">Python学习之上下文管理</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="/2015/10/learning-python-context-management/" class="article-date"><time datetime="2015-10-22T12:00:00.000Z" itemprop="datePublished">2015-10-22</time></a></span> <span class="article-category"><i class="icon icon-folder"></i> <a class="article-category-link" href="/categories/Python/">Python</a></span> <span class="article-tag"><i class="icon icon-tags"></i> <a class="article-tag-link" href="/tags/python/">python</a>, <a class="article-tag-link" href="/tags/上下文管理/">上下文管理</a></span> <span class="article-read hidden-xs"><i class="icon icon-eye-fill" aria-hidden="true"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></span> <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2015/10/learning-python-context-management/#comments" class="article-comment-link">评论</a></span> <span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 869(字)</span></div></div><div class="article-entry marked-body" itemprop="articleBody"><p>最近突发奇想，想写一个能改变当前输出环境，输出彩色文字的上下文管理器，于是学习了一下上下文管理。</p><a id="more"></a><h1 id="1-简介"><a class="markdownIt-Anchor" href="#1-简介"></a> 1. 简介</h1><p>上下文管理器(context manager)是Python2.5开始支持的一种语法，用于规定某个对象的使用范围。一旦进入或者离开该使用范围，会有特殊操作被调用 (比如为对象分配或者释放内存)。一个最简单的例子:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> file(<span class="string">"a.txt"</span>, <span class="string">"r"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    s = f.read()</span><br><span class="line">    <span class="keyword">print</span> f.closed                  <span class="comment"># 此时文件是打开的</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> f.closed                      <span class="comment"># 变量s和f依然存在，但此时f已关闭</span></span><br></pre></td></tr></table></figure><h1 id="2-编写上下文管理器"><a class="markdownIt-Anchor" href="#2-编写上下文管理器"></a> 2. 编写上下文管理器</h1><p>为一个类编写上下文管理器时，需要定义类的<code>__enter__</code>和<code>__exit__</code>函数。</p><h2 id="21-__enter__函数"><a class="markdownIt-Anchor" href="#21-__enter__函数"></a> 2.1 __enter__函数</h2><p><code>__enter__</code>函数规定如下：</p><blockquote><p>contextmanager.__enter__()<br>Enter the runtime context and return either this object or another object related to the runtime context. The value returned by this method is bound to the identifier in the as clause of with statements using this context manager.<br>进入当前上下文，并返回当前对象或另一个与当前上下文相关的对象。被该函数返回的变量会通过该上下文管理器与with文法中as后的声明所绑定。</p></blockquote><p>例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BracketAdder</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># do something with self and runtime context</span></span><br><span class="line">        sys.stdout.write(<span class="string">"("</span>)           <span class="comment"># 输出左括号</span></span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">    <span class="comment"># __exit__函数略</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> BracketAdder() <span class="keyword">as</span> ba:</span><br><span class="line">    <span class="comment"># do_something</span></span><br></pre></td></tr></table></figure><h2 id="22-__exit__函数"><a class="markdownIt-Anchor" href="#22-__exit__函数"></a> 2.2 __exit__函数</h2><p><code>__exit__</code>函数格式如下:</p><blockquote><p>contexmanager.__exit__(exc_type, exc_val, exc_tb)</p></blockquote><p><em>文档太长懒得翻译了</em>_(:зゝ∠)_</p><p>如果代码块中出现异常，<code>exc_type</code>为异常类型，<code>exc_val</code>为该异常，<code>exc_tb</code>为traceback.<code>__exit__</code>函数应返回一个bool类型，若返回值为<code>True</code>, 则在代码块及<code>__exit__</code>函数运行结束后不会抛出任何异常，然后立即执行后面的代码；若返回值为<code>False</code>，则在<code>__exit__</code>函数运行结束后抛出异常。<br>若代码块中未出现异常，则三个变量均为<code>None</code>.<br>例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BracketAdder</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="comment"># __enter__函数略</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></span><br><span class="line">        <span class="comment"># do something with self and runtime context</span></span><br><span class="line">        sys.stdout.write(<span class="string">')'</span>)</span><br><span class="line">        <span class="keyword">if</span> exc_type == NameError:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> BracketAdder():</span><br><span class="line">    <span class="keyword">print</span> a                    <span class="comment"># 若执行这一条引发NameError异常，则异常不会被抛出</span></span><br><span class="line">    a = <span class="number">1</span>/<span class="number">0</span>                    <span class="comment"># 若执行这一条引发ZeroDivisionError, 则异常会被抛出</span></span><br></pre></td></tr></table></figure><h1 id="3-综合示例"><a class="markdownIt-Anchor" href="#3-综合示例"></a> 3. 综合示例</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CManager</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.in_context = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.in_context = <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"I'm entering the context"</span></span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_val, exc_tb)</span>:</span></span><br><span class="line">        self.in_context = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"I'm leaving the context"</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> exc_type == NameError:       <span class="comment"># 拦截NameError异常</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"I'm &#123;status&#125;in the context."</span>.format(</span><br><span class="line">                    status=<span class="string">""</span> <span class="keyword">if</span> self.in_context <span class="keyword">else</span> <span class="string">"not "</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> CManager() <span class="keyword">as</span> ba:</span><br><span class="line">    ba.show()</span><br><span class="line">    <span class="comment"># blahblah</span></span><br><span class="line">    <span class="keyword">raise</span> NameError                     <span class="comment"># 触发NameError异常，代码块后面的语句实际不会执行，而该异常会在__exit__函数中被拦截</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">'k'</span></span><br><span class="line"></span><br><span class="line">ba.show()</span><br></pre></td></tr></table></figure><p>程序输出:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">I&apos;m entering the context</span><br><span class="line">I&apos;m in the context.</span><br><span class="line">I&apos;m leaving the context</span><br><span class="line">I&apos;m not in the context.</span><br></pre></td></tr></table></figure><h1 id="4-参考文档"><a class="markdownIt-Anchor" href="#4-参考文档"></a> 4. 参考文档</h1><ol><li><a href="https://docs.python.org/2.7/library/stdtypes.html#index-37" target="_blank" rel="noopener">Context Manager Types - Python Doc</a></li><li><a href="http://www.cnblogs.com/vamei/archive/2012/11/23/2772445.html" target="_blank" rel="noopener">Python深入02 上下文管理器</a></li><li><a href="http://python.jobbole.com/82494/" target="_blank" rel="noopener">浅谈 Python 的 with 语句</a></li></ol><h1 id="5-后记"><a class="markdownIt-Anchor" href="#5-后记"></a> 5. 后记</h1><p>这些小知识点平时只是粗略的看一下，只能达到会用的程度，有时候觉得只有自己整理一遍才能真正理解它们，才能熟练运用。<br>所以…又填完一个坑。周末简单写写PyQt4吧…</p></div><div class="article-footer"><blockquote class="mt-2x"><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>本文链接：</strong> <a href="https://blog.stdioa.com/2015/10/learning-python-context-management/" title="Python学习之上下文管理" target="_blank" rel="external">https://blog.stdioa.com/2015/10/learning-python-context-management/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！</li></ul></blockquote><div class="panel panel-default panel-badger"><div class="panel-body"><figure class="media"><div class="media-left"><a href="/" target="_blank" class="img-burn thumb-sm visible-lg"><img src="https://www.gravatar.com/avatar/e452ed622e6b1e9a2067a06fde30cf30?s=128" class="img-rounded w-full" alt=""></a></div><div class="media-body"><h3 class="media-heading"><a href="/" target="_blank"><span class="text-dark">David Dai</span><small class="ml-1x">Backend Developer</small></a></h3><div>小孩子。</div></div></figure></div></div></div></article><section id="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="prev"><a href="/2015/10/learning-python-iterator/" title="Python学习之迭代器"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a></li><li class="next"><a href="/2015/10/learning-python-virtualenv/" title="Python学习之virtualenv"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li><li class="toggle-toc"><a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button"><span>[&nbsp;</span><span>文章目录</span> <i class="text-collapsed icon icon-anchor"></i> <i class="text-in icon icon-close"></i> <span>]</span></a></li></ul><div class="bar-right"><div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div></div></div></nav></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="https://github.com/StdioA" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="https://twitter.com/stdio_a" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top"><i class="icon icon-twitter"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li><li><a href="https://t.me/StdioA" target="_blank" title="Telegram" data-toggle="tooltip" data-placement="top"><i class="icon icon-telegram"></i></a></li></ul><div class="copyright"><div class="publishby">Theme by <a href="https://github.com/cofess" target="_blank">cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.</div></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>!function(T){var N={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"};T.INSIGHT_CONFIG=N}(window)</script><script src="/js/insight.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script defer>var disqus_config=function(){this.page.url="https://blog.stdioa.com/2015/10/learning-python-context-management/",this.page.identifier="learning-python-context-management"};!function(){var t=document,e=t.createElement("script");e.src="//stdioa.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><script defer type="text/javascript">!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-65107715-1","auto"),ga("send","pageview")</script></body></html><!-- rebuild by neat -->