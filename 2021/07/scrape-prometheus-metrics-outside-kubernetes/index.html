<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
    <meta name=referrer content=no-referrer-when-downgrade>
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#2a3f5b" />
  <!-- å¼ºåˆ¶é¡µé¢åœ¨å½“å‰çª—å£ä»¥ç‹¬ç«‹é¡µé¢æ˜¾ç¤º,é˜²æ­¢åˆ«äººåœ¨æ¡†æ¶é‡Œè°ƒç”¨é¡µé¢ -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>åœ¨ K3S é›†ç¾¤å¤–ç›‘æ§é›†ç¾¤å†…çš„æŒ‡æ ‡ | Stdio&#39;s Blog</title>
  <meta name="description" content="åƒé¥±äº†æ’‘çš„ï¼Œå°è¯•ä¸€ä¸‹ Prometheus åœ¨ K3S é›†ç¾¤å¤–æŠ“å–é›†ç¾¤å†…æŒ‡æ ‡çš„è‹¥å¹²å§¿åŠ¿ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="åœ¨ K3S é›†ç¾¤å¤–ç›‘æ§é›†ç¾¤å†…çš„æŒ‡æ ‡">
<meta property="og:url" content="https://blog.stdioa.com/2021/07/scrape-prometheus-metrics-outside-kubernetes/index.html">
<meta property="og:site_name" content="Stdio&#39;s Blog">
<meta property="og:description" content="åƒé¥±äº†æ’‘çš„ï¼Œå°è¯•ä¸€ä¸‹ Prometheus åœ¨ K3S é›†ç¾¤å¤–æŠ“å–é›†ç¾¤å†…æŒ‡æ ‡çš„è‹¥å¹²å§¿åŠ¿ã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.stdioa.com/pics/prom-k3s/topo.png">
<meta property="og:image" content="https://blog.stdioa.com/pics/prom-k3s/meme.webp">
<meta property="article:published_time" content="2021-07-11T09:00:00.000Z">
<meta property="article:modified_time" content="2022-09-10T01:41:19.797Z">
<meta property="article:author" content="David Dai">
<meta property="article:tag" content="Prometheus">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="iptables">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.stdioa.com/pics/prom-k3s/topo.png">
  <!-- Canonical links -->
  <link rel="canonical" href="https://blog.stdioa.com/2021/07/scrape-prometheus-metrics-outside-kubernetes/index.html">
  
    <link rel="alternate" href="/atom.xml" title="Stdio&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.min.css">

  
  
  
  
<meta name="generator" content="Hexo 6.3.0"></head>


<body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="/" target="_blank">
          <img class="img-circle img-rotate" src="https://www.gravatar.com/avatar/e452ed622e6b1e9a2067a06fde30cf30?s=128" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">David Dai</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">Backend Developer</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Nanjing, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="æœç´¢" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="æƒ³è¦æŸ¥æ‰¾ä»€ä¹ˆ..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Ã—</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">é¦–é¡µ</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">å½’æ¡£</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">åˆ†ç±»</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">æ ‡ç­¾</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">é¡¹ç›®</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-sheets">
          <a target="_blank" rel="noopener" href="http://sheet.stdioa.com/">
            
            <i class="icon icon-book"></i>
            
            <span class="menu-title">è°±ç«™</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">å‹é“¾</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">å…³äº</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/StdioA" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="https://twitter.com/stdio_a" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
        <li><a href="https://t.me/StdioA" target="_blank" title="Telegram" data-toggle=tooltip data-placement=top><i class="icon icon-telegram"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">å…¬å‘Š</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>æ¬¢è¿ï¼Œä½ æ˜¯ç¬¬ <span id="busuanzi_value_site_pv">å¹¶ä¸çŸ¥é“å¤šå°‘</span> ä¸ªæ¥åˆ°è¿™é‡Œçš„äººã€‚
<p>ä¸è¿‡æˆ‘æ›´æ–°çš„æ¯”è¾ƒå°‘â€¦ä¸å¥½æ„æ€ã€‚</p>
<p>å¦ï¼šæœ¬ç«™ä½¿ç”¨ Disqus è¯„è®ºç³»ç»Ÿï¼Œè‹¥æ–‡ç« é¡µé¢ä¸‹æ–¹æ— æ³•æ˜¾ç¤ºè¯„è®ºæ¡†ï¼Œé‚£è‚¯å®šæ˜¯æ‰“å¼€æ–¹å¼ä¸å¯¹ã€‚</p>

            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">åˆ†ç±»</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/DevOps/">DevOps</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Golang/">Golang</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Javascript/">Javascript</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/LeetCode/">LeetCode</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web/">Web</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B9%B1%E4%B8%83%E5%85%AB%E7%B3%9F/">ä¹±ä¸ƒå…«ç³Ÿ</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/">å¼€å‘</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%BB%9C/">ç½‘ç»œ</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BF%BB%E8%AF%91/">ç¿»è¯‘</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9A%8F%E6%89%8B%E8%AE%B0/">éšæ‰‹è®°</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9A%8F%E7%AC%94/">éšç¬”</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">æ ‡ç­¾äº‘</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/Ajax/" style="font-size: 13px;">Ajax</a> <a href="/tags/Alpine/" style="font-size: 13px;">Alpine</a> <a href="/tags/Apache/" style="font-size: 13px;">Apache</a> <a href="/tags/Atom/" style="font-size: 13px;">Atom</a> <a href="/tags/Beancount/" style="font-size: 13.17px;">Beancount</a> <a href="/tags/CI-CD/" style="font-size: 13.5px;">CI/CD</a> <a href="/tags/CTF/" style="font-size: 13.33px;">CTF</a> <a href="/tags/DevOps/" style="font-size: 13.67px;">DevOps</a> <a href="/tags/Django/" style="font-size: 13.33px;">Django</a> <a href="/tags/Django-REST-Framework/" style="font-size: 13px;">Django REST Framework</a> <a href="/tags/Docker/" style="font-size: 13.33px;">Docker</a> <a href="/tags/Git/" style="font-size: 13.17px;">Git</a> <a href="/tags/GitLab/" style="font-size: 13.5px;">GitLab</a> <a href="/tags/Github/" style="font-size: 13.17px;">Github</a> <a href="/tags/Golang/" style="font-size: 13.33px;">Golang</a> <a href="/tags/Homelab/" style="font-size: 13px;">Homelab</a> <a href="/tags/IPv6/" style="font-size: 13.17px;">IPv6</a> <a href="/tags/Javascript/" style="font-size: 13.17px;">Javascript</a> <a href="/tags/KMS/" style="font-size: 13px;">KMS</a> <a href="/tags/Kubernetes/" style="font-size: 13px;">Kubernetes</a> <a href="/tags/LCTT/" style="font-size: 13px;">LCTT</a> <a href="/tags/LeetCode/" style="font-size: 13px;">LeetCode</a> <a href="/tags/Let-s-Encrypt/" style="font-size: 13px;">Let's Encrypt</a> <a href="/tags/Linux/" style="font-size: 13.33px;">Linux</a> <a href="/tags/MySQL/" style="font-size: 13.17px;">MySQL</a> <a href="/tags/NAS/" style="font-size: 13.17px;">NAS</a> <a href="/tags/NTP/" style="font-size: 13px;">NTP</a> <a href="/tags/PHP/" style="font-size: 13px;">PHP</a> <a href="/tags/Prometheus/" style="font-size: 13.17px;">Prometheus</a> <a href="/tags/Protobuf/" style="font-size: 13px;">Protobuf</a> <a href="/tags/Python/" style="font-size: 13.83px;">Python</a> <a href="/tags/SQL/" style="font-size: 13px;">SQL</a> <a href="/tags/Sublime-Text/" style="font-size: 13px;">Sublime Text</a> <a href="/tags/UTF-8/" style="font-size: 13px;">UTF-8</a> <a href="/tags/Unicode/" style="font-size: 13px;">Unicode</a> <a href="/tags/Windows/" style="font-size: 13px;">Windows</a> <a href="/tags/collections/" style="font-size: 13px;">collections</a> <a href="/tags/ctypes/" style="font-size: 13px;">ctypes</a> <a href="/tags/fava/" style="font-size: 13.17px;">fava</a> <a href="/tags/git/" style="font-size: 13px;">git</a> <a href="/tags/gunicorn/" style="font-size: 13px;">gunicorn</a> <a href="/tags/iptables/" style="font-size: 13px;">iptables</a> <a href="/tags/logging/" style="font-size: 13px;">logging</a> <a href="/tags/nginx/" style="font-size: 13.33px;">nginx</a> <a href="/tags/node-js/" style="font-size: 13.17px;">node.js</a> <a href="/tags/openssl/" style="font-size: 13px;">openssl</a> <a href="/tags/pip/" style="font-size: 13px;">pip</a> <a href="/tags/python/" style="font-size: 14px;">python</a> <a href="/tags/requests/" style="font-size: 13px;">requests</a> <a href="/tags/supervisor/" style="font-size: 13px;">supervisor</a> <a href="/tags/unittest/" style="font-size: 13px;">unittest</a> <a href="/tags/virtualenv/" style="font-size: 13px;">virtualenv</a> <a href="/tags/vue-js/" style="font-size: 13px;">vue.js</a> <a href="/tags/wget/" style="font-size: 13px;">wget</a> <a href="/tags/%E4%B8%83%E7%89%9B/" style="font-size: 13px;">ä¸ƒç‰›</a> <a href="/tags/%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86/" style="font-size: 13px;">ä¸Šä¸‹æ–‡ç®¡ç†</a> <a href="/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" style="font-size: 13.33px;">å‰ç«¯å¼€å‘</a> <a href="/tags/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/" style="font-size: 13px;">åç«¯å¼€å‘</a> <a href="/tags/%E5%A0%86/" style="font-size: 13px;">å †</a> <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" style="font-size: 13.17px;">å¾®æœåŠ¡</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 13px;">æ•°æ®åº“</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/" style="font-size: 13px;">æ•°æ®è¿ç§»</a> <a href="/tags/%E6%96%87%E6%9C%AC%E7%BC%96%E8%BE%91%E5%99%A8/" style="font-size: 13px;">æ–‡æœ¬ç¼–è¾‘å™¨</a> <a href="/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/" style="font-size: 13px;">æ ‘è“æ´¾</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 13px;">ç®—æ³•</a> <a href="/tags/%E7%BC%96%E7%A8%8B%E5%B7%A5%E5%85%B7/" style="font-size: 13px;">ç¼–ç¨‹å·¥å…·</a> <a href="/tags/%E8%84%91%E6%B4%9E/" style="font-size: 13.33px;">è„‘æ´</a> <a href="/tags/%E8%AE%B0%E8%B4%A6/" style="font-size: 13.17px;">è®°è´¦</a> <a href="/tags/%E8%AF%BB%E4%B9%A6/" style="font-size: 13.5px;">è¯»ä¹¦</a> <a href="/tags/%E8%BF%AD%E4%BB%A3%E5%99%A8/" style="font-size: 13px;">è¿­ä»£å™¨</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">å½’æ¡£</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">å…«æœˆ 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">åæœˆ 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">å…­æœˆ 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">ä¹æœˆ 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">ä¸ƒæœˆ 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">äºŒæœˆ 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">åäºŒæœˆ 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">ä¹æœˆ 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">å…­æœˆ 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">äº”æœˆ 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">å››æœˆ 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">ä¸‰æœˆ 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">äºŒæœˆ 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">åäºŒæœˆ 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">åä¸€æœˆ 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">åæœˆ 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">ä¸ƒæœˆ 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">å…­æœˆ 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">ä¸‰æœˆ 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">åäºŒæœˆ 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">åä¸€æœˆ 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">äº”æœˆ 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">å››æœˆ 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">ä¸‰æœˆ 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">äºŒæœˆ 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">ä¸€æœˆ 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">åäºŒæœˆ 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">åä¸€æœˆ 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">åæœˆ 2015</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">ä¹æœˆ 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">ä¸ƒæœˆ 2015</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>


    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">æ–‡ç« ç›®å½•</h3>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-text"> èƒŒæ™¯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nodeport-service"><span class="toc-text"> NodePort Service</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kubernetes-api-proxy"><span class="toc-text"> Kubernetes API Proxy</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-serviceaccount-%E5%8F%8A%E5%AF%B9%E5%BA%94%E7%9A%84-rbac-%E7%AD%96%E7%95%A5"><span class="toc-text"> é…ç½® ServiceAccount åŠå¯¹åº”çš„ RBAC ç­–ç•¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E5%92%8C%E6%8A%93%E5%8F%96%E8%A7%84%E5%88%99"><span class="toc-text"> é…ç½®æœåŠ¡å‘ç°å’ŒæŠ“å–è§„åˆ™</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%93%E9%80%9A-node-network-%E5%92%8C-podservice-network"><span class="toc-text"> æ‰“é€š Node Network å’Œ Pod&#x2F;Service Network</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E7%BC%BA%E4%B9%8F%E7%BB%8F%E9%AA%8C%E5%AF%BC%E8%87%B4%E7%9A%84%E6%97%A0%E8%B0%93-troubleshooting"><span class="toc-text"> ä¸€ä¸ªç¼ºä¹ç»éªŒå¯¼è‡´çš„æ— è°“ troubleshooting</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text"> æ€»ç»“</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-text"> å‚è€ƒèµ„æ–™</span></a></li></ol>
    </nav>
  </div>
</aside>


<main class="main" role="main">
  <div class="content">
  <article id="post-scrape-prometheus-metrics-outside-kubernetes" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      åœ¨ K3S é›†ç¾¤å¤–ç›‘æ§é›†ç¾¤å†…çš„æŒ‡æ ‡
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2021/07/scrape-prometheus-metrics-outside-kubernetes/" class="article-date">
	  <time datetime="2021-07-11T09:00:00.000Z" itemprop="datePublished">2021-07-11</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/DevOps/">DevOps</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/Kubernetes/" rel="tag">Kubernetes</a>, <a class="article-tag-link-link" href="/tags/Prometheus/" rel="tag">Prometheus</a>, <a class="article-tag-link-link" href="/tags/iptables/" rel="tag">iptables</a>
  </span>


        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill" aria-hidden="true"></i>
	    <span id="busuanzi_container_page_pv">
			<span id="busuanzi_value_page_pv">0</span>
		</span>
	</span>


        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/07/scrape-prometheus-metrics-outside-kubernetes/#comments" class="article-comment-link">è¯„è®º</a></span>
        
	
		<span class="post-wordcount hidden-xs" itemprop="wordCount">å­—æ•°ç»Ÿè®¡: 3.6k(å­—)</span>
	
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <p><s>åƒé¥±äº†æ’‘çš„</s>ï¼Œå°è¯•ä¸€ä¸‹ Prometheus åœ¨ K3S é›†ç¾¤å¤–æŠ“å–é›†ç¾¤å†…æŒ‡æ ‡çš„è‹¥å¹²å§¿åŠ¿ã€‚</p>
<span id="more"></span>
<h2 id="èƒŒæ™¯"><a class="markdownIt-Anchor" href="#èƒŒæ™¯"></a> èƒŒæ™¯</h2>
<p>å‰ä¸€é˜µå­æ”¶äº†å—æ ‘è“æ´¾ 4ï¼Œé¡ºæ‰‹åœ¨ä¸Šé¢æ­äº†ä¸€ä¸ªå•èŠ‚ç‚¹çš„ <a target="_blank" rel="noopener" href="https://k3s.io">K3S</a>. å‡ ä¸ªæœˆå‰åœ¨å®¶é‡Œçš„æœåŠ¡å™¨ä¸Šæ­è¿‡ä¸€ä¸ª Prometheus çš„å®ä¾‹ï¼Œäºæ˜¯å°±å†³å®šç ”ç©¶ä¸‹å¦‚ä½•åœ¨é›†ç¾¤å¤–æ”¶é›† K3S é›†ç¾¤å†… Pod çš„æŒ‡æ ‡ã€‚</p>
<p>å…ˆä¸Šä¸€ä¸ªç®€å•çš„ç½‘ç»œæ‹“æ‰‘å›¾ï¼š</p>
<p><img src="/pics/prom-k3s/topo.png" alt="ç½‘ç»œæ‹“æ‰‘" /></p>
<p>ä¼—æ‰€å‘¨çŸ¥ï¼ˆï¼Ÿï¼‰ï¼ŒPod Network å’Œ Node Network æ˜¯ä¸¤ä¸ªä¸åŒçš„ç½‘æ®µï¼Œæ‰€ä»¥åœ¨ Node ä¹‹å¤–æ˜¯æ— æ³•ç›´æ¥è®¿é—®åˆ° Pod çš„ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦é€šè¿‡ä¸€äº›æ–¹æ³•ï¼Œè®©æˆ‘ä»¬ç›´æ¥æˆ–é—´æ¥åœ°è®¿é—® Pod ä¸­æä¾›çš„ HTTP æ¥å£ï¼Œè¿›è€Œå®ŒæˆæŒ‡æ ‡æŠ“å–ã€‚</p>
<p>æˆ‘ä»¬åœ¨ k3s é›†ç¾¤ä¸­éƒ¨ç½²äº†ä¸€ä¸ªæš´éœ²æ¥å£çš„ Deployment ç”¨äºæŒ‡æ ‡æŠ“å–æµ‹è¯•ï¼Œå®ƒçš„æŒ‡æ ‡ç«¯ç‚¹ä¸º <code>http://localhost/metrics</code>.<br />
Deployment é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">promtest</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">promtest</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">promtest</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">prometheus.io/scrape:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">prometheus-test:v0.1</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;/bin/promtest&quot;</span>]</span><br><span class="line">        <span class="attr">args:</span> [<span class="string">&quot;-listen&quot;</span>, <span class="string">&quot;0.0.0.0:80&quot;</span>]</span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<h2 id="nodeport-service"><a class="markdownIt-Anchor" href="#nodeport-service"></a> NodePort Service</h2>
<p>æœ€ç®€å•ã€æœ€ç›´è§‚çš„æ–¹æ³•ï¼Œæ˜¯å°† metrics endpoint é€šè¿‡ NodePort Service æˆ– Ingress æš´éœ²å‡ºæ¥ï¼Œç„¶ååœ¨ Prometheus ä¸­é€šè¿‡é…ç½® <code>static_config</code> æ¥æŠ“å–ã€‚</p>
<p>æ¯”å¦‚æˆ‘ä»¬å¯ä»¥é…ç½®å¦‚ä¸‹çš„ Service å’Œ Ingress:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">promtest</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">promtest</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">prometheus.io/scrape:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">promtest</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">promtest</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">promtest.k3s</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">promtest</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>éƒ¨ç½²åæŸ¥çœ‹ Service çš„ NodePortï¼ˆå¦‚ 30080ï¼‰ï¼Œåˆ™å¯ä»¥é€šè¿‡ Node çš„ç«¯å£è®¿é—®åˆ°æŒ‡æ ‡ç«¯ç‚¹ï¼ˆä¹Ÿå°±æ˜¯  <code>http://192.168.1.101:30080/metrics</code>ï¼‰ï¼›ç±»ä¼¼çš„ï¼Œé€šè¿‡é…ç½®çš„ Ingress ä¹Ÿå¯ä»¥æ­£å¸¸è®¿é—®ï¼ˆ<code>http://promtest.k3s/metrics</code>ï¼‰ã€‚</p>
<p>Prometheus æŠ“å–è§„åˆ™å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">job_name:</span> <span class="string">&quot;exported-services&quot;</span></span><br><span class="line"><span class="attr">static_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.101</span><span class="string">:30080</span>       <span class="comment"># NodePort</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">promtest.k3s</span>              <span class="comment"># Ingress</span></span><br></pre></td></tr></table></figure>
<p>è¿™ç§æ–¹å¼éƒ¨ç½²æ¯”è¾ƒç›´è§‚ç®€å•ï¼Œä½†ç¼ºé™·ä¹Ÿæ¯”è¾ƒæ˜æ˜¾ï¼š</p>
<ol>
<li>ç”±äºæŠ“å–è§„åˆ™éƒ½æ˜¯é™æ€çš„ï¼Œæ‰€ä»¥ä¸èƒ½åšæœåŠ¡å‘ç°ï¼›</li>
<li>æ¯æ·»åŠ ä¸€ä¸ª Deploymentï¼Œéœ€è¦é…ç½®å¯¹åº”çš„ Service æ¥æš´éœ²æŒ‡æ ‡ï¼›</li>
<li>Service è‡ªå¸¦è´Ÿè½½å‡è¡¡ï¼Œæ‰€ä»¥å¦‚æœ Service èƒŒåçš„ Endpoint æœ‰å¤šä¸ªï¼Œé‚£ä¹ˆå¤šæ¬¡æŠ“å–çš„æ•°æ®æ¥æºåˆ™å¯èƒ½æ˜¯ Serivce èƒŒåçš„ä»»æ„ä¸€ä¸ª Podï¼Œè€Œä¸”æˆ‘ä»¬ä¹Ÿæ— æ³•å¯¹æ¥æºè¿›è¡ŒåŒºåˆ†ã€‚å› æ­¤ï¼Œå½“æˆ‘ä»¬åˆ†æä¸šåŠ¡æŒ‡æ ‡æ—¶ï¼Œé€šå¸¸éƒ½ä¼šé€šè¿‡æœåŠ¡å‘ç°æ¥æŠ“å–æ‰€æœ‰ Pod çš„æŒ‡æ ‡ï¼Œç„¶åé€šè¿‡ PromQL æ ¹æ®å®é™…åœºæ™¯å¯¹æŒ‡æ ‡è¿›è¡Œèšåˆã€‚</li>
</ol>
<h2 id="kubernetes-api-proxy"><a class="markdownIt-Anchor" href="#kubernetes-api-proxy"></a> Kubernetes API Proxy</h2>
<p>è¿™ç§æ–¹å¼ç•¥å¾®æœ‰ç‚¹å¥‡æ€ªï¼šä½¿ç”¨ K8S æä¾›çš„ <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/access-application-cluster/access-cluster/#manually-constructing-apiserver-proxy-urls">pod/service proxy æ¥å£</a>ï¼Œé€šè¿‡ä»£ç†æ¥è®¿é—®é›†ç¾¤å†…çš„ Pod æŒ‡æ ‡ç«¯ç‚¹.</p>
<p>å‡è®¾ K8S API åœ°å€ä¸º <code>https://k3s:6443</code>ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬æƒ³è®¿é—® Service proxy æ—¶ï¼Œå°±å¯ä»¥é€šè¿‡ <code>https://k3s:6443/api/v1/namespaces/&lt;namespace&gt;/services/&lt;service_name&gt;[:&lt;service_port&gt;]/proxy/metrics</code> æ¥è·å–ã€‚<br />
ç›¸åº”åœ°ï¼ŒæŠ“å– Pod æŒ‡æ ‡æ—¶ï¼Œå¯¹åº”çš„ API åœ°å€ä¸º <code>https://k8s:6443/api/v1/namespaces/&lt;namespace&gt;/pods/&lt;pod_name&gt;[:&lt;pod_port&gt;]/proxy/metrics</code></p>
<p>ä¸ K8S API è¿›è¡Œäº¤äº’æ—¶ï¼Œéœ€è¦é¦–å…ˆé…ç½®èº«ä»½ä¿¡æ¯ã€‚<br />
é€šå¸¸æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼æ¥è®¿é—®ï¼š</p>
<ol>
<li>HTTPS å®¢æˆ·ç«¯è¯ä¹¦ï¼Œä¸€èˆ¬æƒ…å†µä¸‹äººç±»ç”¨æˆ·ä¼šé€šè¿‡è¿™ç§æ–¹å¼æ¥è®¿é—®ï¼›</li>
<li>ä¸æä¾› HTTPS å®¢æˆ·ç«¯è¯ä¹¦ï¼Œä½†åœ¨ HTTP ä¼šè¯ä¸­é€šè¿‡ Bearer Token çš„æ–¹å¼æä¾› ServiceAccount çš„ JWT Tokenï¼Œè€Œè¿™é€šå¸¸æ˜¯é›†ç¾¤å†…çš„ç¨‹åºè®¿é—® K8S API çš„æ–¹å¼ã€‚</li>
</ol>
<p>Prometheus å¯¹è¿™ä¸¤ç§æ–¹å¼å‡æä¾›äº†æ”¯æŒï¼Œä¸è¿‡æˆ‘è¿˜æ˜¯é€‰æ‹©äº†é…ç½® <code>ServiceAccount</code> æ¥ä¸ K8S äº¤äº’ã€‚</p>
<h3 id="é…ç½®-serviceaccount-åŠå¯¹åº”çš„-rbac-ç­–ç•¥"><a class="markdownIt-Anchor" href="#é…ç½®-serviceaccount-åŠå¯¹åº”çš„-rbac-ç­–ç•¥"></a> é…ç½® ServiceAccount åŠå¯¹åº”çš„ RBAC ç­–ç•¥</h3>
<p>ä¸ºäº†å®Œæˆ K8S èº«ä»½è®¤è¯ä»¥åŠæ¥å£é‰´æƒï¼Œæˆ‘ä»¬éœ€è¦é…ç½®ä»¥ä¸‹èµ„æºï¼š</p>
<ol>
<li><code>ServiceAccount</code>ï¼Œç”¨äºèº«ä»½è®¤è¯ï¼›</li>
<li><code>ClusterRole</code>ï¼Œå®šä¹‰è§’è‰²å’Œæƒé™ï¼›</li>
<li><code>ClusterRoleBinding</code>ï¼Œå°† <code>ClusterRole</code> çš„æƒé™èµ‹äºˆ <code>ServiceAccount</code>.</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://github.com/prometheus-operator/prometheus-operator/blob/master/Documentation/rbac.md#prometheus-rbac">Prometheus Operator æ–‡æ¡£</a> ä¸­æä¾›äº†ä¸€å¥—å®Œæ•´çš„ Service Account å’Œ RBAC é…ç½®ç¤ºä¾‹ï¼Œç”¨äºè¿›è¡ŒæœåŠ¡å‘ç°ã€‚ç”±äºæˆ‘ä»¬è¿˜éœ€è¦è°ƒç”¨ service å’Œ pod çš„ proxy æ¥å£ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦é¢å¤–æ·»åŠ ä¸¤ä¸ª API æƒé™ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">services/proxy</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods/proxy</span></span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br></pre></td></tr></table></figure>
<p>é…ç½®å¥½ <code>ServiceAccount</code> åï¼Œæˆ‘ä»¬å¯ä»¥ä»åä¸º <code>&lt;service_account_name&gt;_token</code> çš„ Secret ä¸­è·å–ç”¨äºèº«ä»½éªŒè¯çš„ JWT Token.</p>
<h3 id="é…ç½®æœåŠ¡å‘ç°å’ŒæŠ“å–è§„åˆ™"><a class="markdownIt-Anchor" href="#é…ç½®æœåŠ¡å‘ç°å’ŒæŠ“å–è§„åˆ™"></a> é…ç½®æœåŠ¡å‘ç°å’ŒæŠ“å–è§„åˆ™</h3>
<p>å¦‚æœ Serivce æˆ– Pod åæ˜¯å·²ç»ç¡®å®šå¥½çš„ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥é€šè¿‡é…ç½® <code>static_config</code> æ¥è¿›è¡ŒæŠ“å–ï¼›ä½†å¦‚æœç”¨åˆ°äº† K8S çš„æœåŠ¡å‘ç°ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿˜éœ€è¦é€šè¿‡æœåŠ¡å‘ç°çš„å…ƒä¿¡æ¯æ¥ç¡®å®šæŒ‡æ ‡æŠ“å–çš„ç›®æ ‡åœ°å€ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#relabel_config"><code>relabel_config</code> é…ç½®</a>ä¸­ï¼Œæœ‰å‡ ä¸ªç‰¹æ®Šçš„ labelï¼Œå¯ä»¥ç”¨æ¥ç»™æˆ‘ä»¬åŠ¨æ€é…ç½®æŠ“å–çš„åœ°å€å’Œåè®®ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li><code>__address__</code>ï¼Œç”¨äºé…ç½®ç›®æ ‡åœ°å€çš„ host å’Œç«¯å£ï¼›</li>
<li><code>__metrics_path__</code>ï¼Œç”¨äºé…ç½®ç›®æ ‡åœ°å€çš„è·¯å¾„ï¼›</li>
<li><code>__scheme__</code>ï¼Œç”¨äºé…ç½®æŠ“å–æ—¶ä½¿ç”¨çš„åè®®ï¼ˆhttp æˆ– httpsï¼‰ï¼›</li>
<li><code>__params_&lt;name&gt;</code>ï¼Œç”¨äºåœ¨æŠ“å–çš„ URL ä¸­æ³¨å…¥ query.</li>
</ul>
<p>æœ‰äº†è¿™å‡ ä¸ªæ ‡ç­¾ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä¸€å®šçš„è§„åˆ™æ¥æ‹¼å‡‘å‡ºç›®æ ‡åœ°å€äº†ã€‚</p>
<p>å…·ä½“æŠ“å–è§„åˆ™å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">job_name:</span> <span class="string">&#x27;k3s-pod-via-api&#x27;</span></span><br><span class="line"><span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line"><span class="attr">tls_config:</span></span><br><span class="line">  <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span>                    <span class="comment"># è·³è¿‡æœåŠ¡å™¨è¯ä¹¦éªŒè¯ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç”¨ ca_file é…ç½®æœåŠ¡å™¨è¯ä¹¦</span></span><br><span class="line"><span class="attr">authorization:</span></span><br><span class="line">  <span class="attr">credentials_file:</span> <span class="string">/etc/prometheus/k8s_token</span>   <span class="comment"># æ–‡ä»¶ä¸­å­˜æœ‰ ServiceAccount token</span></span><br><span class="line"><span class="attr">kubernetes_sd_configs:</span>                          <span class="comment"># æœåŠ¡å‘ç°é…ç½®</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">api_server:</span> <span class="string">https://k3s:6443</span>                <span class="comment"># K8S API åœ°å€</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">pod</span></span><br><span class="line">    <span class="attr">tls_config:</span>                                 <span class="comment"># è¿™éƒ¨åˆ†è·Ÿä¸Šé¢å·®ä¸å¤š</span></span><br><span class="line">      <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">authorization:</span></span><br><span class="line">      <span class="attr">credentials_file:</span> <span class="string">/etc/prometheus/k8s_token</span></span><br><span class="line">    <span class="attr">namespaces:</span>                                 <span class="comment"># å¯é€‰çš„ namespace é…ç½®</span></span><br><span class="line">      <span class="attr">names:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">selectors:</span>                                  <span class="comment"># å¯é€‰çš„ label selector</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">pod</span></span><br><span class="line">        <span class="attr">label:</span> <span class="string">&quot;app=promtest&quot;</span></span><br><span class="line"><span class="attr">relabel_configs:</span></span><br><span class="line"><span class="comment"># åªæŠ“å–åŒ…å« `prometheus.io/scrape: true` annotation çš„ Pod</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_scrape</span>]</span><br><span class="line">  <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">  <span class="attr">regex:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line"><span class="comment"># å¦‚æœå®šä¹‰äº† `prometheus.io/port` æ³¨è§£ï¼Œåˆ™ç”¨å®ƒè¦†ç›– Pod å®šä¹‰ä¸­çš„ç«¯å£å·</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_port</span>]</span><br><span class="line">  <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">  <span class="attr">regex:</span> <span class="string">(\d+)</span></span><br><span class="line">  <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">  <span class="attr">target_label:</span> <span class="string">__meta_kubernetes_pod_container_port_number</span></span><br><span class="line"><span class="comment"># åŠ¨æ€æ„å»º K8S proxy API åœ°å€</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>, <span class="string">__meta_kubernetes_pod_name</span>, <span class="string">__meta_kubernetes_pod_container_port_number</span>]</span><br><span class="line">  <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">  <span class="attr">regex:</span> <span class="string">(.+);(.+);(.+)</span></span><br><span class="line">  <span class="attr">replacement:</span> <span class="string">api/v1/namespaces/$1/pods/$2:$3/proxy/metrics</span></span><br><span class="line">  <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line"><span class="comment"># é€šè¿‡ `prometheus.io/path` æ³¨è§£è‡ªå®šä¹‰æŠ“å–è·¯å¾„</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__metrics_path__</span>, <span class="string">__meta_kubernetes_pod_annotation_prometheus_io_path</span>]</span><br><span class="line">  <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">  <span class="attr">regex:</span> <span class="string">(.+)/metrics;/?(.+)</span></span><br><span class="line">  <span class="attr">replacement:</span> <span class="string">$1/$2</span></span><br><span class="line">  <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line"><span class="comment"># Host å’Œ Port æ˜¯ç¡®å®šçš„</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">source_labels:</span> []</span><br><span class="line">  <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">  <span class="attr">regex:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">replacement:</span> <span class="string">a.r8:6443</span></span><br><span class="line">  <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line"><span class="comment"># å°†ä¸€äº›å…ƒä¿¡æ¯æ³¨å…¥åˆ° metrics æ ‡ç­¾ä¸­</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">  <span class="attr">regex:</span> <span class="string">__meta_kubernetes_pod_label_(.+)</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]</span><br><span class="line">  <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">  <span class="attr">target_label:</span> <span class="string">k8s_namespace</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_name</span>]</span><br><span class="line">  <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">  <span class="attr">target_label:</span> <span class="string">k8s_pod_name</span></span><br></pre></td></tr></table></figure>
<p>Service çš„æŠ“å–å’Œ Pod å¤§åŒå°å¼‚ï¼Œåªæ˜¯ç›®æ ‡åœ°å€å’Œ meta æ ‡ç­¾åä¸å¤ªä¸€æ ·ï¼Œå°±ä¸èµ˜è¿°äº†ã€‚</p>
<p>è¿™ç§æ–¹å¼å¯ä»¥ä½¿ç”¨ K8S çš„æœåŠ¡å‘ç°åŠŸèƒ½ï¼Œä½†é€šè¿‡ proxy API æ¥è®¿é—® Podï¼Œä¹ŸåŠ é‡äº† <code>kube-apiserver</code> çš„è´Ÿæ‹…ã€‚è€Œä¸”ï¼Œè¯´å¥å®è¯ï¼Œå†™è¿™ç§æ‹¼å‡‘ API åœ°å€çš„ <code>relabel_config</code> è¿˜æ˜¯æŒºè›‹ç–¼çš„ã€‚ ğŸŒš</p>
<p>å¦‚æœä¸ä½¿ç”¨ K8S çš„ proxy API çš„è¯ï¼Œä¹Ÿå¯ä»¥ç®€å•åœ¨é›†ç¾¤å†…éƒ¨ç½²ä¸€ä¸ª HTTP åå‘ä»£ç†ï¼Œç„¶åé€šè¿‡åä»£æ¥æŠ“å– Pod æˆ– Service çš„æŒ‡æ ‡ã€‚<br />
è¿™ä¸ªæ–¹æ¡ˆå…¶å®è·Ÿä¸Šä¸€ç§å·®ä¸å¤šï¼Œåªæ˜¯æŠŠ kube-apiserver çš„ proxy æ¢æˆäº†é›†ç¾¤å†…çš„å¦å¤–ä¸€ä¸ª proxy è€Œå·²ï¼Œä¸è¿‡å‡è½»äº† <code>kube-apiserver</code> çš„è´Ÿæ‹…ã€‚<br />
è€ƒè™‘åˆ°å®‰å…¨å› ç´ ï¼Œæˆ‘ä»¬å¯ä»¥ä¸º proxy é…ç½® egress <code>NetworkPolicy</code> æ¥æ§åˆ¶å®ƒå¯ä»¥è®¿é—®çš„ Podï¼Œä½†è¿™æ ·ä¹Ÿä¼šä½¿æƒé™å’Œé€‰æ‹©ç­–ç•¥å˜å¾—æä¸ºåˆ†æ•£ã€‚</p>
<h2 id="æ‰“é€š-node-network-å’Œ-podservice-network"><a class="markdownIt-Anchor" href="#æ‰“é€š-node-network-å’Œ-podservice-network"></a> æ‰“é€š Node Network å’Œ Pod/Service Network</h2>
<p>è¿™ç§æ–¹æ³•ç®—æ˜¯ä»æ ¹æœ¬ä¸Šè§£å†³é—®é¢˜ï¼šæ‰“é€š Node å’Œ Pod / Service ç½‘ç»œï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥è®¿é—® Pod æˆ– Service çš„ IP æ¥æŠ“å–æŒ‡æ ‡ã€‚</p>
<p>æ‰“é€šç½‘ç»œçš„æ“ä½œä¸»è¦å‚è€ƒäº†ä¸¤ç¯‡æ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://www.qikqiak.com/post/office-env-k8s-network/">ã€ŠåŠå…¬ç¯å¢ƒä¸‹ kubernetes ç½‘ç»œäº’é€šæ–¹æ¡ˆã€‹</a>ä»¥åŠ<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/187548589">ã€Šæ‰“é€š Kubernetes å†…ç½‘ä¸å±€åŸŸç½‘çš„Nç§æ–¹æ³•ã€‹</a>ï¼Œæœ€åé€‰æ‹©ä»ç½‘ç»œå±‚æ‰“é€šç½‘ç»œã€‚</p>
<p>æ“ä½œå¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨ server ä¸­é…ç½®ä¸¤æ¡è·¯ç”±è§„åˆ™å³å¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip route add 10.42.0.0/16 via 192.168.1.101 dev enp1s0</span><br><span class="line">ip route add 10.43.0.0/16 via 192.168.1.101 dev enp1s0</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæƒ³è¦åœ¨å±€åŸŸç½‘å†…æ‰“é€šçš„è¯ï¼Œå¯ä»¥åœ¨è·¯ç”±å™¨çš„ç®¡ç†åå°æ¥é…ç½®é™æ€è·¯ç”±è§„åˆ™ï¼›å¦‚æœé›†ç¾¤å­˜åœ¨å¤šä¸ªèŠ‚ç‚¹ï¼Œåˆ™è¿˜éœ€åœ¨ Node çš„ iptables ä¸­é…ç½® <code>MASQUERADE</code> è§„åˆ™ç”¨äºè½¬å‘ã€‚<br />
é…ç½®å®Œæˆåï¼ŒPrometheus å°±å¯ä»¥ç›´æ¥é€šè¿‡ Pod IP æˆ– Service çš„ Cluster IP æ¥æŠ“å–æŒ‡æ ‡äº†ã€‚</p>
<p>Pod çš„æŠ“å–è§„åˆ™å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">job_name:</span> <span class="string">&#x27;k3s-pod&#x27;</span></span><br><span class="line"><span class="comment"># æŠ“å–æ—¶ç›´æ¥é€šè¿‡ HTTP åè®®ä» Pod IP æŠ“å–ï¼Œæ‰€ä»¥æ— éœ€é‰´æƒ</span></span><br><span class="line"><span class="attr">kubernetes_sd_configs:</span>spacespacespacespacespace<span class="comment"># æœåŠ¡å‘ç°é…ç½®ä¸å˜</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">api_server:</span> <span class="string">https://k8s:6443</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">pod</span></span><br><span class="line">    <span class="attr">tls_config:</span></span><br><span class="line">      <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">authorization:</span></span><br><span class="line">      <span class="attr">credentials_file:</span> <span class="string">/etc/prometheus/k8s_token</span></span><br><span class="line"><span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="comment"># ç­›é€‰æ³¨è§£è§„åˆ™åŒä¸Š</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_scrape</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">  <span class="comment"># æ ¹æ® `prometheus.io/path` æ³¨è§£ç›´æ¥è¦†ç›–æŒ‡æ ‡è·¯å¾„</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_path</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">  <span class="comment"># æ ¹æ® `prometheus.io/port` æ³¨è§£è¦†ç›–ç«¯å£</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>, <span class="string">__meta_kubernetes_pod_annotation_prometheus_io_port</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">$1:$2</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># å…ƒä¿¡æ¯è§„åˆ™åŒä¸Š</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">__meta_kubernetes_pod_label_(.+)</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">k8s_namespace</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_name</span>]</span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">k8s_pod_name</span></span><br></pre></td></tr></table></figure>
<p>Service çš„æŠ“å–è§„åˆ™ç•¥ã€‚</p>
<p>å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥ç›´æ¥è®¿é—® Podï¼Œé‚£ä¹ˆæŠ“å–æ—¶çš„ relabel è§„åˆ™å°±å¯ä»¥ç®€åŒ–å¾ˆå¤šã€‚</p>
<h3 id="ä¸€ä¸ªç¼ºä¹ç»éªŒå¯¼è‡´çš„æ— è°“-troubleshooting"><a class="markdownIt-Anchor" href="#ä¸€ä¸ªç¼ºä¹ç»éªŒå¯¼è‡´çš„æ— è°“-troubleshooting"></a> ä¸€ä¸ªç¼ºä¹ç»éªŒå¯¼è‡´çš„æ— è°“ troubleshooting</h3>
<p>ä¹‹å‰é€šè¿‡ <a target="_blank" rel="noopener" href="https://github.com/argoproj/argo-cd/blob/master/manifests/install.yaml">Argo CD å®‰è£…è„šæœ¬</a> åœ¨é›†ç¾¤å†…å®‰è£…äº† Argo CD. å½“æˆ‘é…å®Œä¸Šé¢çš„è§„åˆ™ä»¥åï¼Œæˆ‘å‘ç° <code>argocd-metrics</code> Service çš„æŒ‡æ ‡æ— æ³•é€šè¿‡ Cluster IP æŠ“å–ï¼ˆæŠ¥é”™â€Connection refusedâ€œï¼‰ï¼Œè€Œ <code>argocd-server-metrics</code> å°±å¯ä»¥ã€‚è€Œåœ¨ Node ä¸Šï¼Œä¸¤ä¸ªæœåŠ¡å‡å¯ä»¥æ­£å¸¸è®¿é—®ã€‚</p>
<p>æŸ¥äº† Node ä¸Šçš„ <code>iptables</code> è§„åˆ™ï¼Œæ²¡æœ‰åœ¨ Service (<code>argocd-metrics</code>) åˆ° Pod (<code>argocd-application-controller-0</code>) çš„è½¬å‘é“¾è·¯ä¸­å‘ç°ä»»ä½•å¼‚å¸¸ï¼Œç›´æ¥è®¿é—® Pod IP ä¹ŸéªŒè¯äº†è¿™ä¸€ç‚¹ã€‚<br />
ä½†ç”±äºç¼ºä¹ iptables debug ç»éªŒï¼Œå¹¶æ²¡æœ‰æ‰¾åˆ°è®¿é—® Pod IP è¢«æ‹’ç»çš„åŸå› ã€‚</p>
<p>æœ€åé€šè¿‡ç„å­¦ debugï¼Œå‘ç° <code>argocd</code> namespace çš„äº”ä¸ª Pod é‡Œï¼Œåªæœ‰ä¸€ä¸ªå¯ä»¥æ­£å¸¸è®¿é—®ï¼Œæœ€åæ‰¾åˆ°äº†å®‰è£…è„šæœ¬ä¸­é…ç½®çš„ <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/network-policies/#networkpolicy-resource">NetworkPolicy</a>ï¼Œå‘ç°æœ‰äº”ä¸ª NetworkPolicy é™åˆ¶äº†æ¯ä¸ª Pod çš„ ingress æ¥æºã€‚<br />
å°† Node æ‰€åœ¨å±€åŸŸç½‘çš„ CIDRï¼ˆ<code>192.168.1.1/24</code>ï¼‰æ·»åŠ è‡³ <code>argocd-application-controller-network-policy</code> çš„ ingress ç™½åå•ä¸­ï¼Œé—®é¢˜è§£å†³ã€‚</p>
<p>è¯´å®è¯ï¼Œä¹‹å‰ç¡®å®æ²¡æœ‰æ€ä¹ˆæ¥è§¦è¿‡ <code>NetworkPolicy</code>ï¼Œå¯¼è‡´è¿™ä¸ªé—®é¢˜æˆ‘æŸ¥äº†å°†è¿‘å››å¤©æ‰æŸ¥å‡ºæ¥â€¦</p>
<p>äº‹ååˆ†æå®Œæ•´çš„è½¬å‘é“¾å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Service -&gt; Pod with DNAT</span></span><br><span class="line">-A KUBE-SERVICES -d 10.43.4.242/32 -p tcp -m tcp --dport 8082 -m comment --comment <span class="string">&quot;argocd/argocd-metrics:metrics cluster IP&quot;</span> -j KUBE-SVC-SZWGFJCG7JW62ZG2</span><br><span class="line">-A KUBE-SVC-SZWGFJCG7JW62ZG2 -m comment --comment <span class="string">&quot;argocd/argocd-metrics:metrics&quot;</span> -j KUBE-SEP-VYRHUQXWRJ6MSGOH</span><br><span class="line">-A KUBE-SEP-VYRHUQXWRJ6MSGOH -p tcp -m tcp -m comment --comment <span class="string">&quot;argocd/argocd-metrics:metrics&quot;</span> -j DNAT --to-destination 10.42.0.38:8082</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pod è½¬å‘è‡³ pod é˜²ç«å¢™</span></span><br><span class="line">-A KUBE-ROUTER-OUTPUT -d 10.42.0.38/32 -m comment --comment <span class="string">&quot;rule to jump traffic destined to POD name:argocd-application-controller-0 namespace: argocd to chain KUBE-POD-FW-XIOATVM5TOINSO4V&quot;</span> -j KUBE-POD-FW-XIOATVM5TOINSO4V</span><br><span class="line"></span><br><span class="line">-A KUBE-POD-FW-XIOATVM5TOINSO4V -m conntrack --ctstate RELATED,ESTABLISHED -m comment --comment <span class="string">&quot;rule for stateful firewall for pod&quot;</span> -j ACCEPT</span><br><span class="line"><span class="comment"># é€šè¿‡ local mode (ä¹Ÿå°±æ˜¯ä» node ip) è®¿é—® pod çš„åŒ…éƒ½ä¼šè¢«æ‰¹å‡†</span></span><br><span class="line">-A KUBE-POD-FW-XIOATVM5TOINSO4V -d 10.42.0.38/32 -m addrtype --src-type LOCAL -m comment --comment <span class="string">&quot;rule to permit the traffic traffic to pods when source is the pod\&#x27;s local node&quot;</span> -j ACCEPT</span><br><span class="line"><span class="comment"># æ¥å— argocd-application-controller-network-policy çš„è§„åˆ™åˆ¤æ–­ï¼Œé€šè¿‡åä¼šè¢«æ‰“ä¸Šæ ‡è®°</span></span><br><span class="line">-A KUBE-POD-FW-XIOATVM5TOINSO4V -m comment --comment <span class="string">&quot;run through nw policy argocd-application-controller-network-policy&quot;</span> -j KUBE-NWPLCY-5VLCZNPWIAXAL2HB</span><br><span class="line">-A KUBE-POD-FW-XIOATVM5TOINSO4V -m mark ! --mark 0x10000/0x10000 -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 10/min --limit-burst 10 -m comment --comment <span class="string">&quot;rule to log dropped traffic POD name:argocd-application-controller-0 namespace: argocd&quot;</span> -j NFLOG --nflog-group 100</span><br><span class="line"><span class="comment"># æ²¡æœ‰æ ‡è®°ï¼ˆæ²¡é€šè¿‡è§„åˆ™åˆ¤æ–­ï¼‰ï¼Œå°±ä¼šæ‹’ç»è¿æ¥</span></span><br><span class="line">-A KUBE-POD-FW-XIOATVM5TOINSO4V -m mark ! --mark 0x10000/0x10000 -m comment --comment <span class="string">&quot;rule to REJECT traffic destined for POD name:argocd-application-controller-0 namespace: argocd&quot;</span> -j REJECT --reject-with icmp-port-unreachable</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¬¬ä¸€æ¡ namespaceSelector è§„åˆ™ï¼Œå¯¹åº” 8082 ç«¯å£</span></span><br><span class="line"><span class="comment"># namespaceSelector: &#123;&#125;</span></span><br><span class="line"><span class="comment"># æ»¡è¶³æ¡ä»¶åˆ™ä¼šæ‰“ä¸Šæ ‡è®°ï¼Œç„¶å return</span></span><br><span class="line">-A KUBE-NWPLCY-5VLCZNPWIAXAL2HB -p tcp -m <span class="built_in">set</span> --match-set KUBE-SRC-DRBIHPAD4OLOF546 src -m <span class="built_in">set</span> --match-set KUBE-DST-DM6ZQPCTKCXEROGZ dst -m tcp --dport 8082 -m comment --comment <span class="string">&quot;rule to mark traffic matching a network policy&quot;</span> -m comment --comment <span class="string">&quot;rule to ACCEPT traffic from source pods to dest pods selected by policy name argocd-application-controller-network-policy namespace argocd&quot;</span> -j MARK --set-xmark 0x10000/0x10000</span><br><span class="line">-A KUBE-NWPLCY-5VLCZNPWIAXAL2HB -p tcp -m <span class="built_in">set</span> --match-set KUBE-SRC-DRBIHPAD4OLOF546 src -m <span class="built_in">set</span> --match-set KUBE-DST-DM6ZQPCTKCXEROGZ dst -m tcp --dport 8082 -m comment --comment <span class="string">&quot;rule to RETURN traffic matching a network policy&quot;</span> -m mark --mark 0x10000/0x10000 -m comment --comment <span class="string">&quot;rule to ACCEPT traffic from source pods to dest pods selected by policy name argocd-application-controller-network-policy namespace argocd&quot;</span> -j RETURN</span><br><span class="line"></span><br><span class="line"><span class="comment"># è‡ªå·±åŠ ä¸Šå»çš„ç¬¬äºŒæ¡ ipBlock cidr è§„åˆ™ï¼Œ8082 ç«¯å£</span></span><br><span class="line"><span class="comment">#  ipBlock:</span></span><br><span class="line"><span class="comment">#    cidr: 192.168.1.0/24</span></span><br><span class="line">-A KUBE-NWPLCY-5VLCZNPWIAXAL2HB -p tcp -m <span class="built_in">set</span> --match-set KUBE-SRC-MLGAJX4FU64MJPWH src -m <span class="built_in">set</span> --match-set KUBE-DST-DM6ZQPCTKCXEROGZ dst -m tcp --dport 8082 -m comment --comment <span class="string">&quot;rule to mark traffic matching a network policy&quot;</span> -m comment --comment <span class="string">&quot;rule to ACCEPT traffic from specified ipBlocks to dest pods selected by policy name: argocd-application-controller-network-policy namespace argocd&quot;</span> -j MARK --set-xmark 0x10000/0x10000</span><br><span class="line">-A KUBE-NWPLCY-5VLCZNPWIAXAL2HB -p tcp -m <span class="built_in">set</span> --match-set KUBE-SRC-MLGAJX4FU64MJPWH src -m <span class="built_in">set</span> --match-set KUBE-DST-DM6ZQPCTKCXEROGZ dst -m tcp --dport 8082 -m comment --comment <span class="string">&quot;rule to RETURN traffic matching a network policy&quot;</span> -m mark --mark 0x10000/0x10000 -m comment --comment <span class="string">&quot;rule to ACCEPT traffic from specified ipBlocks to dest pods selected by policy name: argocd-application-controller-network-policy namespace argocd&quot;</span> -j RETURN</span><br></pre></td></tr></table></figure>
<p>ipset è§„åˆ™å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¬¬ä¸€æ¡ namespaceSelector è§„åˆ™</span></span><br><span class="line">Name: KUBE-SRC-DRBIHPAD4OLOF546</span><br><span class="line">Type: <span class="built_in">hash</span>:ip</span><br><span class="line">Revision: 4</span><br><span class="line">Header: family inet hashsize 1024 maxelem 65536 <span class="built_in">timeout</span> 0</span><br><span class="line">Size <span class="keyword">in</span> memory: 1008</span><br><span class="line">References: 4</span><br><span class="line">Number of entries: 16</span><br><span class="line">Members:</span><br><span class="line">10.42.0.41 <span class="built_in">timeout</span> 0</span><br><span class="line">10.42.0.40 <span class="built_in">timeout</span> 0</span><br><span class="line"><span class="comment"># åé¢çš„ pod ip åœ°å€ç•¥</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¬¬äºŒæ¡ ipblock cidr è§„åˆ™</span></span><br><span class="line">Name: KUBE-SRC-MLGAJX4FU64MJPWH</span><br><span class="line">Type: <span class="built_in">hash</span>:net</span><br><span class="line">Revision: 6</span><br><span class="line">Header: family inet hashsize 1024 maxelem 65536 <span class="built_in">timeout</span> 0</span><br><span class="line">Size <span class="keyword">in</span> memory: 440</span><br><span class="line">References: 4</span><br><span class="line">Number of entries: 1</span><br><span class="line">Members:</span><br><span class="line">192.168.1.0/24 <span class="built_in">timeout</span> 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç›®æ ‡åœ°å€è§„åˆ™ï¼ˆNetworkPolicy ä¸­ podSelector åˆ—å‡ºçš„æ‰€æœ‰ IPï¼‰</span></span><br><span class="line"><span class="comment"># podSelector:</span></span><br><span class="line"><span class="comment">#   matchLabels:</span></span><br><span class="line"><span class="comment">#     app.kubernetes.io/name: argocd-application-controller</span></span><br><span class="line">Name: KUBE-DST-DM6ZQPCTKCXEROGZ</span><br><span class="line">Type: <span class="built_in">hash</span>:ip</span><br><span class="line">Revision: 4</span><br><span class="line">Header: family inet hashsize 1024 maxelem 65536 <span class="built_in">timeout</span> 0</span><br><span class="line">Size <span class="keyword">in</span> memory: 168</span><br><span class="line">References: 8</span><br><span class="line">Number of entries: 1</span><br><span class="line">Members:</span><br><span class="line">10.42.0.38 <span class="built_in">timeout</span> 0</span><br></pre></td></tr></table></figure>
<p>â€¦â€¦</p>
<p><img src="/pics/prom-k3s/meme.webp" alt="æˆ‘åªæ˜¯ä¸ªå°å¼€å‘.webp" /></p>
<h2 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h2>
<p>ä»é›†ç¾¤å¤–è®¿é—®é›†ç¾¤å†…çš„æ¥å£æœ‰å¾ˆå¤šç§æ–¹å¼ï¼Œå¦‚æœæ˜¯ä¸€èˆ¬çš„ä¸šåŠ¡éœ€æ±‚ï¼Œæˆ‘ä»¬é€šå¸¸è¿˜æ˜¯ä¼šç”¨ Service / Ingress æ¥å®Œæˆã€‚ä½†ä¸ºäº†ç®€åŒ–é…ç½®ï¼Œä½¿ç”¨é›†ç¾¤å±‚é¢çš„æœåŠ¡å‘ç°ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç»•äº›å¼¯è·¯æ¥è®¿é—®æŒ‡æ ‡æ¥å£ã€‚</p>
<p>å¦‚æœå®åœ¨æ˜¯å¸Œæœ›åœ¨é›†ç¾¤å¤–æ”¶é›†æŒ‡æ ‡çš„è¯ï¼ˆæ¯”å¦‚ä½¿ç”¨äº†æŒ‡æ ‡æ”¶é›†çš„ PaaS æœåŠ¡ï¼Œå¦‚é˜¿é‡Œäº‘ SLSï¼‰ï¼Œé‚£ä¹ˆä»å®‰å…¨æ€§å’Œä¾¿æ·æ€§å‡ºå‘ï¼Œæˆ‘è®¤ä¸ºæœ€åˆç†çš„æ¶æ„è¿˜æ˜¯åº”è¯¥åœ¨ K8S é›†ç¾¤å†…éƒ¨ç½²ä¸€ä¸ª Prometheus ç”¨äºé›†ç¾¤å†…çš„æŒ‡æ ‡æŠ“å–ã€‚é›†ç¾¤å†…çš„ Prometheus å¯ä»¥é€šè¿‡ Service / Ingress å°†æš´éœ²å‡ºæ¥ï¼Œè¿™æ ·é›†ç¾¤å¤–çš„ Prometheus å®ä¾‹å¯ä»¥é€šè¿‡ <a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/federation/">federate æ¥å£</a>ç›´æ¥æŠ“å–åˆ°é›†ç¾¤å†… Prometheus çš„æŒ‡æ ‡ã€‚<br />
ç”±äºé›†ç¾¤å†…çš„ Prometheus ä¸»è¦ç”¨äºæŠ“å–å’Œæ•°æ®è½¬å‘ï¼Œæ‰€ä»¥æ— éœ€ä¿ç•™è¿‡å¤šæ•°æ®ï¼Œä¹Ÿä¸éœ€è¦å¤ªå…³æ³¨æŒä¹…åŒ–å› ç´ ã€‚</p>
<p><s>é‚£ä¹ˆï¼ŒæŠ˜è…¾äº†åŠå¤©ï¼Œæˆ‘ä¸ºä»€ä¹ˆè¦åœ¨é›†ç¾¤å¤–æŠ“å–é›†ç¾¤å†…çš„æŒ‡æ ‡å‘¢ã€‚</s></p>
<h2 id="å‚è€ƒèµ„æ–™"><a class="markdownIt-Anchor" href="#å‚è€ƒèµ„æ–™"></a> å‚è€ƒèµ„æ–™</h2>
<p>é™¤äº† Kubernetes å’Œ Prometheus å®˜ç½‘å¤–ï¼Œæˆ‘è¿˜å‚è€ƒäº†ä»¥ä¸‹é¡µé¢ï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/prometheus/prometheus/blob/release-2.28/documentation/examples/prometheus-kubernetes.yml">Prometheus kuberenetes_sd_config ç¤ºä¾‹</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/prometheus-operator/prometheus-operator/blob/master/Documentation/rbac.md#prometheus-rbac">Prometheus RBAC é…ç½®</a></li>
<li><a target="_blank" rel="noopener" href="https://www.qikqiak.com/post/office-env-k8s-network/">ã€ŠåŠå…¬ç¯å¢ƒä¸‹ kubernetes ç½‘ç»œäº’é€šæ–¹æ¡ˆã€‹</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/187548589">ã€Šæ‰“é€š Kubernetes å†…ç½‘ä¸å±€åŸŸç½‘çš„Nç§æ–¹æ³•ã€‹</a></li>
</ul>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
      <a href="https://blog.stdioa.com/2021/07/scrape-prometheus-metrics-outside-kubernetes/" title="åœ¨ K3S é›†ç¾¤å¤–ç›‘æ§é›†ç¾¤å†…çš„æŒ‡æ ‡" target="_blank" rel="external">https://blog.stdioa.com/2021/07/scrape-prometheus-metrics-outside-kubernetes/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>ç‰ˆæƒå£°æ˜ï¼š </strong> æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CNåè®®</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="/" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="https://www.gravatar.com/avatar/e452ed622e6b1e9a2067a06fde30cf30?s=128" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="/" target="_blank"><span class="text-dark">David Dai</span><small class="ml-1x">Backend Developer</small></a></h3>
        <div>å°å­©å­ã€‚</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2021/09/homelab-share/" title="HomeLab ç©æ³•ç®€å•åˆ†äº«"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;ä¸Šä¸€ç¯‡</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2021/02/alpine-time-call/" title="ç”± TT-RSS è§£ææ•°æ®åº“åœ°å€å¤±è´¥å¼•å‡ºçš„ä¸€ä¸ªé—®é¢˜"><span>ä¸‹ä¸€ç¯‡&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="æ–‡ç« ç›®å½•" role="button">
        <span>[&nbsp;</span><span>æ–‡ç« ç›®å½•</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/StdioA" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="https://twitter.com/stdio_a" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
        <li><a href="https://t.me/StdioA" target="_blank" title="Telegram" data-toggle=tooltip data-placement=top><i class="icon icon-telegram"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'æ–‡ç« ',
            PAGES: 'é¡µé¢',
            CATEGORIES: 'åˆ†ç±»',
            TAGS: 'æ ‡ç­¾',
            UNTITLED: '(æœªå‘½å)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>






   
    
    <script defer>
    var disqus_config = function () {
        
            this.page.url = 'https://blog.stdioa.com/2021/07/scrape-prometheus-metrics-outside-kubernetes/';
        
        this.page.identifier = 'scrape-prometheus-metrics-outside-kubernetes';
    };
    (function() { 
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'stdioa' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>






    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JLS011CGS8"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { window.dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-JLS011CGS8');
</script>
<!-- End Google Analytics -->





</body>
</html>